openapi: 3.0.3
info:
  title: Usage API (WIP)
  version: v2-2025-04-15
  description: |
    OpenAPI YAML generated from the "Usage API - WIP - Sharable (V2, April 15)" PDF.
    Some response schemas are inferred from examples and may require adjustment.

servers:
  - url: https://{host}
    variables:
      host:
        default: api.example.com

security:
  - bearerAuth: []

tags:
  - name: Organization
  - name: Teams
  - name: License
  - name: Permissions
  - name: Usage
  - name: Users

paths:
  /api/v1/organization:
    get:
      tags: [Organization]
      summary: Get current organization ID and high-level settings
      responses:
        "200":
          description: Successful response with organization structure.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Organization"
              examples:
                example:
                  value:
                    publicKey: "-----BEGIN PUBLIC KEY-----\nMIICIXXXXXXAAQ==\n-----END PUBLIC KEY-----\n"
                    samlEnabled: false
                    smtpConfigured: true
                    usernamePasswordEnabled: true
                    name: Yagel
                    domains: [tabnine.com]
                    planType: Enterprise
                    id: 9a3895ca-1c27-4231-8978-85ae00267d02
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /api/v1/organization/teams:
    get:
      tags: [Teams]
      summary: Get list of teams for the given organization
      parameters:
        - $ref: "#/components/parameters/offsetOptional"
        - $ref: "#/components/parameters/limitOptional"
      responses:
        "200":
          description: Successful response with list of teams.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TeamListResponse"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /api/v1/license:
    get:
      tags: [License]
      summary: Get license info
      responses:
        "200":
          description: Successful response with license info.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LicenseResponse"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /api/v1/organization/account-utilizations:
    get:
      tags: [Organization]
      summary: Get account utilization info (monthly)
      parameters:
        - name: startDate
          in: query
          required: false
          description: |
            Start date for showing utilization (YYYY-MM).
            Default: last 12 months.
          schema:
            type: string
            pattern: '^\d{4}-\d{2}$'
          example: "2025-01"
      responses:
        "200":
          description: Successful response with monthly utilization array.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccountUtilizations"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /api/v1/instance/permissions:
    get:
      tags: [Permissions]
      summary: Get account permissions info (list of account admins)
      parameters:
        - name: role
          in: query
          required: true
          schema:
            type: string
          example: Admin
      responses:
        "200":
          description: Successful response with users for the given role.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PermissionUsers"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /api/v1/organization/usage:
    get:
      tags: [Usage, Organization]
      summary: Get organization-level usage
      parameters:
        - name: organizationId
          in: query
          required: true
          description: The unique identifier of the organization
          schema:
            type: string
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
        - $ref: "#/components/parameters/granularity"
      responses:
        "200":
          description: Successful response with organization usage data.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrgUsageResponse"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /api/v1/team/{teamId}/users:
    get:
      tags: [Teams, Users]
      summary: Get users of a given team
      parameters:
        - name: teamId
          in: path
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/offsetRequired"
        - $ref: "#/components/parameters/limitRequired"
      responses:
        "200":
          description: Successful response with users for the team.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TeamUsersResponse"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /api/v1/organization/users:
    get:
      tags: [Organization, Users]
      summary: Get users who are not assigned to a team
      parameters:
        - $ref: "#/components/parameters/offsetRequired"
        - $ref: "#/components/parameters/limitRequired"
        - name: teamMember
          in: query
          required: true
          description: Use false for users not assigned to a team.
          schema:
            type: boolean
          example: false
        - name: active
          in: query
          required: true
          description: Use true for registered users (false for deactivated users).
          schema:
            type: boolean
          example: true
      responses:
        "200":
          description: Successful response with users.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedUsersResponse"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /api/v1/team/account-utilizations:
    get:
      tags: [Teams]
      summary: Get current team utilization info
      parameters:
        - name: teamId
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful response with team utilization counts.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TeamUtilization"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /api/v1/team/{teamId}:
    get:
      tags: [Teams]
      summary: Get team name
      parameters:
        - name: teamId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful response with team info.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TeamName"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /api/v1/team/usage:
    get:
      tags: [Usage, Teams]
      summary: Team-level usage
      parameters:
        - name: organizationId
          in: query
          required: true
          schema: { type: string }
        - name: teamId
          in: query
          required: true
          schema: { type: string }
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
        - $ref: "#/components/parameters/granularity"
      responses:
        "200":
          description: Successful response with team usage data.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TeamUsageResponse"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /api/v1/user/{user_id}:
    get:
      tags: [Users]
      summary: User-level info
      parameters:
        - name: user_id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Successful response with user info.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserInfoResponse"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

  /api/v1/user/usage:
    get:
      tags: [Usage, Users]
      summary: User-level usage
      parameters:
        - name: organizationId
          in: query
          required: true
          schema: { type: string }
        - name: userId
          in: query
          required: true
          schema: { type: string }
        - $ref: "#/components/parameters/from"
        - $ref: "#/components/parameters/to"
        - $ref: "#/components/parameters/granularity"
      responses:
        "200":
          description: Successful response with user usage data.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserUsageResponse"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/InternalServerError" }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    offsetOptional:
      name: offset
      in: query
      required: false
      description: Skips a number of items before starting to return results.
      schema:
        type: integer
        minimum: 0
        default: 0
    limitOptional:
      name: limit
      in: query
      required: false
      description: Maximum number of items to return.
      schema:
        type: integer
        minimum: 0
        default: 0
    offsetRequired:
      name: offset
      in: query
      required: true
      description: Skips a number of items before starting to return results.
      schema:
        type: integer
        minimum: 0
    limitRequired:
      name: limit
      in: query
      required: true
      description: Maximum number of items to return.
      schema:
        type: integer
        minimum: 0
    from:
      name: from
      in: query
      required: true
      description: Filter usage data from this date (ISO 8601).
      schema:
        type: string
        format: date-time
    to:
      name: to
      in: query
      required: true
      description: Filter usage data until this date (ISO 8601).
      schema:
        type: string
        format: date-time
    granularity:
      name: granularity
      in: query
      required: true
      description: Time resolution at which usage data is aggregated and returned.
      schema:
        type: string
        enum: [all, daily, weekly, monthly]

  responses:
    BadRequest:
      description: Bad Request – Invalid or missing parameters.
    Unauthorized:
      description: Unauthorized – Invalid token.
    Forbidden:
      description: Forbidden – User lacks permission.
    NotFound:
      description: Not Found – Resource not found.
    InternalServerError:
      description: Internal Server Error – Unexpected server error.

  schemas:
    Organization:
      type: object
      required: [id, name]
      properties:
        publicKey:
          type: string
          description: Public key in PEM format.
        samlEnabled: { type: boolean }
        smtpConfigured: { type: boolean }
        usernamePasswordEnabled: { type: boolean }
        name: { type: string }
        domains:
          type: array
          items: { type: string }
        planType: { type: string }
        id: { type: string }

    Team:
      type: object
      required: [id, name]
      properties:
        id: { type: string }
        name: { type: string }
        usersCount:
          type: integer
          minimum: 0
        isDefaultTeam: { type: boolean }

    Meta:
      type: object
      properties:
        count: { type: integer, minimum: 0 }
        total: { type: integer, minimum: 0 }
        next:
          type: object
          nullable: true
          properties:
            limit: { type: integer, minimum: 0 }
            offset: { type: integer, minimum: 0 }

    TeamListResponse:
      type: object
      properties:
        data:
          type: array
          items: { $ref: "#/components/schemas/Team" }
        meta: { $ref: "#/components/schemas/Meta" }

    LicenseResponse:
      type: object
      properties:
        license: { $ref: "#/components/schemas/License" }

    License:
      type: object
      properties:
        exp: { type: integer, format: int64 }
        iat: { type: integer, format: int64 }
        seats: { type: integer, minimum: 0 }
        seatsCap: { type: integer, minimum: 0 }
        audience: { type: string }
        features:
          type: array
          items: { type: string }
        settings:
          type: object
          additionalProperties: true

    UtilizationMonth:
      type: object
      required: [year, month, registered, deactivated, active, pending]
      properties:
        year: { type: integer, minimum: 1970 }
        month:
          type: integer
          minimum: 0
          maximum: 11
          description: Zero-based month (0=January, 11=December).
        registered: { type: integer, minimum: 0 }
        deactivated: { type: integer, minimum: 0 }
        active: { type: integer, minimum: 0 }
        pending: { type: integer, minimum: 0 }

    AccountUtilizations:
      type: array
      items: { $ref: "#/components/schemas/UtilizationMonth" }

    PermissionUser:
      type: object
      required: [username, organizationId]
      properties:
        username: { type: string }
        organizationId: { type: string }

    PermissionUsers:
      type: array
      items: { $ref: "#/components/schemas/PermissionUser" }

    UsageContainer:
      type: object
      required: [granularity, data]
      properties:
        granularity:
          type: string
          enum: [all, daily, weekly, monthly]
        data:
          type: array
          items: { $ref: "#/components/schemas/UsageBlock" }

    UsageBlock:
      type: object
      required: [from, to, activeUsers]
      properties:
        from: { type: string, format: date-time }
        to: { type: string, format: date-time }
        activeUsers: { type: integer, minimum: 0 }
        productivityFactor: { type: number }
        codeCompletions: { $ref: "#/components/schemas/CodeCompletions" }
        chat: { $ref: "#/components/schemas/ChatUsage" }

    CodeCompletions:
      type: object
      properties:
        activeUsers: { type: integer, minimum: 0 }
        completions: { type: integer, minimum: 0 }
        charsCompleted: { type: integer, minimum: 0 }
        keystrokes: { type: integer, minimum: 0 }
        lines: { type: integer, minimum: 0 }
        automationFactor: { type: number }

    ChatUsage:
      type: object
      properties:
        activeUsers: { type: integer, minimum: 0 }
        interactions: { type: integer, minimum: 0 }
        usefulChatInteractions: { type: integer, minimum: 0 }
        lines: { type: integer, minimum: 0 }
        charsCompleted: { type: integer, minimum: 0 }
        chatConsumptionRate: { type: number }

    OrgUsageResponse:
      type: object
      required: [organizationId, from, to, usage]
      properties:
        organizationId: { type: string }
        from: { type: string, format: date-time }
        to: { type: string, format: date-time }
        usage: { $ref: "#/components/schemas/UsageContainer" }

    TeamUsageResponse:
      type: object
      required: [organizationId, teamId, from, to, usage]
      properties:
        organizationId: { type: string }
        teamId: { type: string }
        from: { type: string, format: date-time }
        to: { type: string, format: date-time }
        usage: { $ref: "#/components/schemas/UsageContainer" }

    UserUsageResponse:
      type: object
      required: [organizationId, userId, from, to, usage]
      properties:
        organizationId: { type: string }
        userId: { type: string }
        from: { type: string, format: date-time }
        to: { type: string, format: date-time }
        usage: { $ref: "#/components/schemas/UsageContainer" }

    TeamUser:
      type: object
      required: [id, username, email, role, verified]
      properties:
        id: { type: string }
        username: { type: string }
        email: { type: string, format: email }
        role: { type: string }
        verified: { type: boolean }
        deactivatedAt: { type: string, format: date-time, nullable: true }
        updatedAt: { type: string, format: date-time, nullable: true }

    TeamUsersResponse:
      type: object
      properties:
        data:
          type: array
          items: { $ref: "#/components/schemas/TeamUser" }
        meta: { $ref: "#/components/schemas/Meta" }

    PaginatedUsersResponse:
      type: object
      properties:
        data:
          type: array
          items: { $ref: "#/components/schemas/TeamUser" }
        meta: { $ref: "#/components/schemas/Meta" }

    TeamUtilization:
      type: object
      required: [registered, deactivated, invited]
      properties:
        registered: { type: integer, minimum: 0 }
        deactivated: { type: integer, minimum: 0 }
        invited: { type: integer, minimum: 0 }

    TeamName:
      type: object
      required: [id, name]
      properties:
        id: { type: string }
        name: { type: string }

    UserInfoResponse:
      type: object
      properties:
        user:
          type: object
          properties:
            organization_id: { type: string }
            user_id: { type: string }
            email: { type: string, format: email }
            role: { type: string }
            createdAt: { type: string, format: date-time }
            updatedAt: { type: string, format: date-time }
        teams:
          type: object
          properties:
            team_id: { type: string }
            team_name: { type: string }
